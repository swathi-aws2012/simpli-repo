name: Deploy Node.js Login App to Amazon ECS

on:
  push:
    branches:
      - main

env:
  AWS_REGION: us-east-1                  # ðŸ”¹ Change to your region
  CLUSTER_NAME: simplyicard-dev           # ðŸ”¹ Your ECS cluster name
  SERVICE_NAME: simplyicard-dev-taskdefinition-service           # ðŸ”¹ Your ECS service name
  TASK_FAMILY: simplyicard-dev-taskdefinition               # ðŸ”¹ Your ECS task definition family
  ECR_REPOSITORY: simplyicard-repo       # ðŸ”¹ Your ECR repo
  IMAGE_TAG: latest                      # ðŸ”¹ Always use latest or commit SHA

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Amazon ECR registry
        id: ecr
        run: |
          echo "registry=$(aws sts get-caller-identity --query 'Account' --output text).dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com" >> $GITHUB_OUTPUT

      - name: Update ECS Task Definition
        run: |
          echo "ðŸ“„ Fetching current task definition...."
          TASK_DEF=$(aws ecs describe-task-definition --task-definition $TASK_FAMILY)

          echo "ðŸ“ Preparing new revision..."
          NEW_TASK_DEF=$(echo $TASK_DEF | jq --arg IMAGE "${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}" \
            '.taskDefinition | 
             .containerDefinitions[0].image=$IMAGE |
             {family: .family, containerDefinitions: .containerDefinitions, executionRoleArn: .executionRoleArn, networkMode: .networkMode, requiresCompatibilities: .requiresCompatibilities, cpu: .cpu, memory: .memory}')

          echo $NEW_TASK_DEF > new-task-def.json

          echo "ðŸ“Œ Registering new task definition..."
          aws ecs register-task-definition --cli-input-json file://new-task-def.json

      - name: Deploy ECS Service
        run: |
          echo "ðŸš€ Updating ECS service with new task..."
          aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --force-new-deployment
          echo "âœ… Deployment triggered successfully!"
